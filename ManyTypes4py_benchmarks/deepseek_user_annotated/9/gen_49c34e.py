#!/usr/bin/env python

import io
import pathlib
from collections import defaultdict
from typing import Dict, Set, List, Tuple, Any, DefaultDict, IO, Optional, Union

import multidict

ROOT: pathlib.Path = pathlib.Path.cwd()
while ROOT.parent != ROOT and not (ROOT / "pyproject.toml").exists():
    ROOT = ROOT.parent


def calc_headers(root: pathlib.Path) -> List[multidict.istr]:
    hdrs_file: pathlib.Path = root / "aiohttp/hdrs.py"
    code: Any = compile(hdrs_file.read_text(), str(hdrs_file), "exec")
    globs: Dict[str, Any] = {}
    exec(code, globs)
    headers: List[multidict.istr] = [
        val for val in globs.values() if isinstance(val, multidict.istr)
    ]
    return sorted(headers)


headers: List[multidict.istr] = calc_headers(ROOT)


def factory() -> DefaultDict[Any, Any]:
    return defaultdict(factory)


TERMINAL: object = object()


def build(headers: List[multidict.istr]) -> DefaultDict[Any, Any]:
    dct: DefaultDict[Any, Any] = defaultdict(factory)
    for hdr in headers:
        d: DefaultDict[Any, Any] = dct
        for ch in hdr:
            d = d[ch]
        d[TERMINAL] = hdr
    return dct


dct: DefaultDict[Any, Any] = build(headers)


HEADER: str = """\
/*  The file is autogenerated from aiohttp/hdrs.py
Run ./tools/gen.py to update it after the origin changing. */

#include "_find_header.h"

#define NEXT_CHAR() \\
{ \\
    count++; \\
    if (count == size) { \\
        /* end of search */ \\
        return -1; \\
    } \\
    pchar++; \\
    ch = *pchar; \\
    last = (count == size -1); \\
} while(0);

int
find_header(const char *str, int size)
{
    char *pchar = str;
    int last;
    char ch;
    int count = -1;
    pchar--;
"""

BLOCK: str = """
{label}
    NEXT_CHAR();
    switch (ch) {{
{cases}
        default:
            return -1;
    }}
"""

CASE: str = """\
        case '{char}':
            if (last) {{
                return {index};
            }}
            goto {next};"""

FOOTER: str = """
{missing}
missing:
    /* nothing found */
    return -1;
}}
"""


def gen_prefix(prefix: str, k: str) -> str:
    if k == "-":
        return prefix + "_"
    else:
        return prefix + k.upper()


def gen_block(
    dct: DefaultDict[Any, Any],
    prefix: str,
    used_blocks: Set[str],
    missing: Set[str],
    out: IO[str]
) -> None:
    cases: Dict[str, str] = {}
    for k, v in dct.items():
        if k is TERMINAL:
            continue
        next_prefix: str = gen_prefix(prefix, k)
        term: Optional[multidict.istr] = v.get(TERMINAL)
        if term is not None:
            index: int = headers.index(term)
        else:
            index = -1
        hi: str = k.upper()
        lo: str = k.lower()
        case: str = CASE.format(char=hi, index=index, next=next_prefix)
        cases[hi] = case
        if lo != hi:
            case = CASE.format(char=lo, index=index, next=next_prefix)
            cases[lo] = case
    label: str = prefix + ":" if prefix else ""
    if cases:
        block: str = BLOCK.format(label=label, cases="\n".join(cases.values()))
        out.write(block)
    else:
        missing.add(label)
    for k, v in dct.items():
        if not isinstance(v, defaultdict):
            continue
        block_name: str = gen_prefix(prefix, k)
        if block_name in used_blocks:
            continue
        used_blocks.add(block_name)
        gen_block(v, block_name, used_blocks, missing, out)


def gen(dct: DefaultDict[Any, Any]) -> io.StringIO:
    out: io.StringIO = io.StringIO()
    out.write(HEADER)
    missing: Set[str] = set()
    gen_block(dct, "", set(), missing, out)
    missing_labels: str = "\n".join(sorted(missing))
    out.write(FOOTER.format(missing=missing_labels))
    return out


def gen_headers(headers: List[multidict.istr]) -> io.StringIO:
    out: io.StringIO = io.StringIO()
    out.write("# The file is autogenerated from aiohttp/hdrs.py\n")
    out.write("# Run ./tools/gen.py to update it after the origin changing.")
    out.write("\n\n")
    out.write("from . import hdrs\n")
    out.write("cdef tuple headers = (\n")
    for hdr in headers:
        out.write("    hdrs.{},\n".format(hdr.upper().replace("-", "_")))
    out.write(")\n")
    return out


# print(gen(dct).getvalue())
# print(gen_headers(headers).getvalue())


folder: pathlib.Path = ROOT / "aiohttp"

with (folder / "_find_header.c").open("w") as f:
    f.write(gen(dct).getvalue())

with (folder / "_headers.pxi").open("w") as f:
    f.write(gen_headers(headers).getvalue())
